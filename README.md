![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/298fc368-7e98-473e-9259-9c0a6688ca8e)# smart IOT security system

## 시스템 개요

자취를 하는 사람들은 대부분 도둑, 화재에 대한 걱정이 많다. 혼자 살기 때문에 집을 비운 동안 누가 들어오지는 않을지, 불이 나지는 않을지 항상 불안해하곤 한다. 이런 불안을 해소하고자 ‘자취생을 위한 스마트 홈 IOT 보안 시스템’을 제작했다.

 이 시스템은, 초음파 센서를 통해 외부인의 침입을 감지하고, 온도 센서를 통해 화재를 감지해 웹 페이지에 알림을 보낸다. 사용자는 웹 페이지의 알림을 확인하고, 카메라를 통해 실시간 내 자취방의 상황을 확인할 수 있다. 또, 사용의 편리함을 위해 LED와 스위치를 통해 시스템을 제어할 수 있게 제작되었다.
 사용자는 웹 페이지에 접속해서 Connect 버튼을 누르면 자동으로 연결되고, 시스템은 상황에 따라 사용자에게 알림을 보낸다. 집에 도둑이 들었다고 판단하면 도둑 그림이, 화재가 났다고 판단되면 불 그림이 웹 페이지에 나타난다. 특히 도둑이 들었을 경우에는 추후 경찰에 신고해야 하기 때문에 자동으로 카메라가 사진을 촬영한다. 도둑이 든 시간을 알기 위해 파일의 이름을 현재 날짜와 시간으로 설정한다. 알림을 받은 사용자는 “실시간 영상 보기” 버튼을 통해 실시간 자취방의 모습을 확인할 수 있다. 또, “온도 보기” 버튼을 통해 실시간 방의 온도를 확인할 수도 있다.
 
 초록색 LED에 불이 들어오면 이 시스템이 정상적으로 작동함을 의미한다. 스위치를 누르면 초록색 LED의 불은 꺼지고, 빨간색 LED가 점등된다. 이 때는 시스템이 작동을 멈추고 감지하지 않는다. 사용자가 집에 들어와서 더 이상 자취방을 감시할 필요가 없을 때를 가정하고 제작됐다.

 ![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/60efe08b-bf27-45b9-a830-5501ea7ff2df)


## 시스템 구조
![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/e3f0c0ce-08cc-47e4-9f6a-410883dddea8)
이 시스템은 MQTT 프로토콜을 사용해 제작됐다. 센서는 그 값을 받아 MQTT Broker(pub.py)에게 전송하고, Broker는 각 센서값을 이용해 시스템을 제어한다. 또, 카메라 역시 pub.py에서 제어한다. 

메인이 되는 project 디렉토리에는 전체 센서를 제어하고 그 값을 받아 publishing하는 Pub.py 파일과 웹 페이지를 구성하는 pFlask.py 파일이 있다. pFlask.py를 통해 웹 페이지를 구성하는데 필요한 js파일과 css 파일은 static 디렉토리에 있다. 또, 웹 페이지에서 사용자에게 알림을 보내는 역할을 하는 Fire.jpg와 Thief.png 파일도 있다. templates 디렉토리에는 메인 웹 페이지의 역할을 하는 index.html, 실시간 CCTV를 보여주는 역할을 하는 Show_cctv.html 파일이 있다.

js 파일에서는(Flask 서버를 이용해 subscribe) pub.py에게 받은 결과값을 이용해 페이지를 구성하도록 한다. 또, 카메라 제어를 위한 구독-구독해제 부분도 포함하고 있다. 외에도 사용자 IP를 자동으로 입력하는 부분 역시 포함되어 있다.

라즈베리파이는 센서 값을 제어하는 제어 컴퓨터이자, 웹 서버를 구동하는 서버로 사용된다. 
각 파일은 분리되어 있어(pub.py, pflask.py) 두 파일의 실행이 필요하다. 실행은 putty linux terminal을 통해 실행할 수 있다.

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/a47f0b49-5a72-4318-8c8c-0b2f8320a123)
이 시스템의 실제 회로 구성 모습이다. GPIO extension board를 이용해 센서를 연결했다. 브레드보드는 케이블을 이용해 라즈베리파이에 연결되어 각 값을 제어한다.
초음파 센서, 온습도 센서가 각각 도둑 침입, 화재 감지를 위해 사용됐으며 제어를 위한 스위치와 상태 확인을 위한 LED 2개도 확인할 수 있다.

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/0a090675-ff8d-48fb-bc9c-69546e5d6d6b)
시스템 제작을 위한 브레드보드 구조

## 시스템 작동 모습

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/e3ff628c-d952-4e36-bf2b-c118c24f93ac)
스마트 홈 IOT 보안 시스템 웹 페이지의 초기 화면 브로커 IP와 포트 번호는 자동으로 입력된다. 사용자는 웹페이지의 각 버튼을 통해 센서를 제어하고 그 값을 읽어올 수 있다.

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/204031c0-1f90-45ea-9719-0b436358a4e4)
Connect 버튼을 눌러 연결 상태를 확인할 수 있다.

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/21cf625c-b6e2-4d66-be30-57d5de132ef3)
온도 센서는 일정 온도 이상이 측정되는 경우 불이 났다고 판단한다. 테스트 및 ReadMe 작성을 위해 온도를 섭씨 20도로 설정해 둬서 시스템이 불이 났다고 판단했다. 
불이 났다고 판단해 불 사진이 올라온 모습. 이 부분을 카카오톡 API 등을 이용해 다른 방식으로 알림을 전송할 수도 있다.
실제 사용에선 코드를 수정해 임계 온도를 더 높은 온도로 설정하면 된다.

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/9fac8318-7866-473c-be9d-b67c080457e2)
온도가 20도를 넘는 상황에서 초음파 센서의 측정값이 변해 도둑이 들었다고 판단되어 웹 페이지에 도둑 그림이 나타난 모습. 마찬가지로 다른 방법으로 알림을 사용할 수 있다.

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/140312c9-9085-4a5d-9d23-bde5a46ecb56)
특히 도둑이 들었다고 판단된 경우엔, 그 순간에 자동으로 사진을 찍는다. 
경찰에 신고하기 위함이다. 
FTP 프로그램인 FileZilla 클라이언트를 통해 project-static 폴더에 현재 시간을 기준으로 한 사진 파일이 저장되었음을 확인할 수 있다. 증거자료로 사용!

![image](https://github.com/Jun-Young-Seo/IOT_smart_security_home/assets/128452954/d0a6e691-e1a0-44f4-9420-86fe4bba77aa)
사용자가 “실시간 영상 보기” 버튼을 누른 모습. 현재 카메라가 비추고 있는 모습을 웹 페이지에서 확인할 수 있다. 인형이 도둑이라고 가정한다면, 도둑이 들었다고 판단해 바로 경찰에 신고할 수 있다.
모바일 환경인 경우, html의 tel 태그를 통해 이를 더 간편하게 할 수도 있을 것이다.


### 프로젝트 결론 및 느낀 점....

처음엔 초음파 센서가 말썽이었다. 초음파를 발사하고 수신하는 코드 사이에 sleep(0.1) 코드가 없었는데, 컴퓨터가 너무 빨리 작동하면서 문제를 일으켰다. 
초음파 발사 후에 수신하기도 전에 다시 발사하면서 문제가 일어났던 것이다. 한참을 헤매다 결국 문제가 일어나는 근본적인 원인을 생각하게 됐고, 코드 한 줄로 문제를 해결할 수 있었다.

 두 번째 어려움은 코딩이었다. 객체지향언어 1, 2 강의를 수강하면서 배운 객체지향적 프로그래밍을 적용하고 싶었다. 교재에 있는 코드를 이해하고, 객체지향적으로 코드를 작성하기 위해 많이 노력했다. 
 사실 완벽하게 캡슐화를 하지도, 클래스를 엄청 멋지게 활용하지도 못했다. 하지만 직접 코딩을 하면서 왜 객체지향 프로그래밍이 대세가 될 수 밖에 없었는지, 어떻게 구조를 짜야 좋은 코드인지 직접 느낄 수 있었다. 
 아직 실력이 부족하다는 점도 많이 느꼈다. 객체 지향에 대해 좀 더 활용하려는 시도를 해 봐야 할 것 같다.

 마지막 어려움은 카메라 자원의 공유 문제였다. 해결하기 가장 어려웠다. 문제 원인을 파악하기 어려웠기 때문이다.
 내가 제작을 원하는 시스템은 도둑이 드는 순간의 사진도 촬영하고, 실시간 자취방 영상을 보여줄 수도 있어야 했다. 
 실시간 영상 보기를 먼저 구현했었다. 처음엔 단순히 책에 있는 코드를 베껴 쓴 수준이었다. 실시간 영상 보기 코드를 Flask 코드에 삽입했었는데, 이렇게 하면 하나의 카메라 자원을 pFlask.py 파일과 pub.py 파일이 공유하게 된다. 
 뒤에 실행하는 파일은 카메라를 인식할 수 없다는 오류를 냈다. 문제의 원인을 찾는 것 조차 쉽지 않았다. 처음에는 카메라나 USB 포트의 고장인 줄 알고 이리저리 바꿔가며 온갖 테스트를 다 했다. 
 초음파 센서 때와 마찬가지로 코드에 목 메는 것이 아닌 전체적인 구조를 파악하고 근본적인 원인을 찾는데 집중하자 결국 문제를 찾아낼 수 있었다.
 
 내가 문제 해결을 위해 택한 방법은, 카메라 자원을 하나의 파일만 쓸 수 있도록 새로운 topic을 설정해 구독하는 것이었다. cameraControl 토픽에, release와 activate 메시지를 넣어 publishing하는 방식이다. 
 시스템이 동작을 시작하면 이 토픽을 시스템이 미리 구독한다. 도둑이 들면 카메라는 사진을 계속 찍다가, 사용자가 실시간 영상 보기를 누르는 순간, 카메라 자원을 해제하는 camerControl topic에 release 메시지를 넣어 보낸다. 
 그럼 pub.py 파일은 카메라 자원을 해제하고, pFlask.py 파일이 카메라 자원을 가져가게 된다. 반대로 실시간 영상 보기 페이지에서 돌아가기 버튼을 누르면 pFlask.py 파일이 카메라 자원을 해제한다.

 단순히 생각하면 웹 캠 두대를 구비해 설치하면 될 일이다. 하지만, 실제로 어떤 솔루션 시스템을 제작하는 경우에 자원을 추가하는 것이 그렇게 만만할까. 나에게 있는 자원만을 활용해 프로젝트를 완성하는 것이 목표였다.

이번 프로젝트를 통해 정말 많은 것을 배울 수 있었다. 내가 처음 생각하는 프로그래머는 단순히 책상에 앉아 머리를 싸매고 코드를 작성하는 사람이었다. 
하지만 이번 프로젝트를 통해, 진짜 실력 있는 프로그래머는 하드웨어와 소프트웨어를 막론하고 전체적인 이해가 필요하다는 것을 깨닫게 됐다. 
만약 코드가 동작하는 방식, 센서가 값을 받아오는 방식, 회로가 구성되는 방식, MQTT 프로토콜, Flask 프레임워크 등 어떤 것 하나라도 제대로 이해하지 못했다면 내가 하고자 하는 프로젝트를 완성하지 못했을 것이다.

교수님께서 강조해 오시던 “결국은 이론 싸움이다.”라는 말을 뼈저리게 느낄 수 있었다. 프로젝트를 통해 단순히 코드를 짜는데에 급급하던 눈이 더 넓은 세상을 볼 수 있는 눈으로 트인 느낌이다. 
앞으로도 도전해 볼 수 있는 프로젝트가 몇 개 더 있을 텐데, 오늘의 교훈을 바탕으로 더 근사한 무언가를 완성해보고 싶다.


